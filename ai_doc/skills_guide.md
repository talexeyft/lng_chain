# Руководство по скиллам (Skills)

Подробная инструкция: как добавлять новые скиллы, виды скиллов, именование, классические блоки и указание инструментов.

---

## 1. Что такое скилл

**Скилл** — это директория с файлом `SKILL.md`, которая описывает, как агенту выполнять определённую задачу или работать в определённой области. Скилл подсказывает агенту:
- **когда** применять этот навык (триггеры);
- **какие инструменты** использовать;
- **как** выполнять шаги и в каком формате отдавать результат.

В проекте скиллы лежат в `skills/<имя-скилла>/`. Агент загружает их из `agent.py` (список имён директорий в `skill_sources`). Чтобы новый скилл начал использоваться, его директорию нужно добавить в этот список.

---

## 2. Как добавить новый скилл

### Шаг 1: Создать директорию

```
skills/
└── my-skill/
    └── SKILL.md
```

Минимум — одна папка и один файл `SKILL.md`. Опционально: `reference.md`, `examples.md`, скрипты в `scripts/`.

### Шаг 2: Написать SKILL.md

Обязательно:
- YAML-frontmatter в начале файла (поля `name`, `description`);
- описание назначения и пошаговые инструкции в теле.

### Шаг 3: Подключить скилл в агенте

В `agent.py` в списке имён скиллов добавить имя папки:

```python
skill_sources = [
    str(skills_dir / name)
    for name in ("md-search", "presentation", "technical-stats", "my-skill")  # добавили my-skill
    if (skills_dir / name).is_dir()
]
```

После этого агент будет видеть новый скилл при загрузке.

---

## 3. Виды скиллов

Удобно различать скиллы по назначению. От этого зависят акценты в описании и блоках.

| Вид | Назначение | Пример в проекте | На что делать упор |
|-----|------------|-------------------|--------------------|
| **Инструментный** | Работа с одним/несколькими конкретными тулами | md-search, web-search | `allowed-tools`, порядок вызовов, обработка результата |
| **Доменный** | Знание предметной области + данные/схемы | technical-stats | Схема данных, методология, шаблоны отчётов |
| **Воркфлоуный** | Пошаговый сценарий с чеклистами | technical-stats (сценарий «низкий трафик») | Шаги, чеклисты, условия, циклы отладки |
| **Генераторный** | Создание артефакта по шаблону | presentation | Структура вывода, примеры формата, скрипт/тул |

В одном скилле могут сочетаться несколько видов (например, technical-stats — и доменный, и воркфлоуный, и инструментный).

---

## 4. Именование

### Имя скилла (папка и `name` во frontmatter)

- **Формат:** только латиница в нижнем регистре, цифры и дефис: `[a-z0-9-]+`.
- **Длина:** до 64 символов (рекомендация Cursor).
- **Стиль:** кратко и по смыслу — что делает скилл, а не «helper»/«utils».

Примеры:

| Уместно | Неуместно |
|--------|-----------|
| `md-search` | `search`, `helper` |
| `technical-stats` | `stats`, `db` |
| `presentation` | `pptx`, `slides-util` |
| `web-search` | `internet`, `browser` |

Имя папки и поле `name` во frontmatter должны совпадать с тем, что указано в `agent.py`.

### Имена инструментов (для `allowed-tools`)

В коде инструменты объявляются через `@tool` и получают имя функции в **snake_case**. В `allowed-tools` указываются именно эти имена, через запятую, без пробелов внутри имени:

```yaml
allowed-tools: search_md_docs, search_md_docs_semantic
allowed-tools: query_stats_db, execute_analysis_script, list_experiment_artifacts
```

Ошибки: `searchMdDocs`, `query-stats-db`, лишние пробелы внутри имени.

---

## 5. Классические блоки SKILL.md

Ниже — типовые секции и для чего они нужны. Не все обязательны; выбирать по виду скилла.

### 5.1 YAML-frontmatter (обязательно)

В самом начале файла, между `---` и `---`:

```yaml
---
name: short-skill-name
description: Краткое описание: что делает скилл и когда его применять. Пишется в третьем лице. Указывать триггеры (когда использовать).
allowed-tools: tool_one, tool_two
compatibility: Требования (Ollama, API-ключ, путь к данным и т.д.). Опционально.
---
```

- **name** — идентификатор, совпадает с именем папки.
- **description** — главное для выбора скилла агентом: что делаем + когда (триггеры). Лучше конкретные формулировки и ключевые слова.
- **allowed-tools** — список инструментов через запятую. Подсказка агенту: при следовании этому скиллу использовать эти тулы.
- **compatibility** — по желанию: зависимости, переменные окружения, пути.

Пример из проекта:

```yaml
---
name: technical-stats
description: Описывает техническую статистику сети и работу с ней — SQLite-база ai_data/network_stats.db, таблица network_stats, read-only SQL. Использовать при запросах пользователя о статистике сети, KPI, метриках, отчётах по NE, трафике, качестве, eDRX, дропах, задержках, нагрузке.
allowed-tools: query_stats_db, execute_analysis_script, list_experiment_artifacts
---
```

### 5.2 Заголовок и Overview

Сразу после frontmatter — заголовок первого уровня и краткий обзор:

```markdown
# Краткое название скилла

## Overview (или «Назначение»)

Один–два абзаца: для чего этот скилл, в каких запросах его применять.
```

Пример (md-search):

```markdown
# md-search

## Overview

Навык для быстрого поиска по локальной базе Markdown-документов.
```

### 5.3 Instructions (инструкции)

Основной блок — пошаговые указания агенту. Для инструментного скилла — какие тулы вызывать и в каком порядке; для воркфлоуного — шаги и чеклисты.

Пример (инструментный):

```markdown
## Instructions

1. Всегда запускай оба инструмента для одного запроса:
   - `search_md_docs` (точные совпадения по тексту),
   - `search_md_docs_semantic` (поиск по смыслу).
2. После получения результатов объединяй выдачу: убирай дубликаты по `path`, приоритет — результатам с обоими типами совпадений.
3. В ответе показывай: какие файлы найдены, короткие релевантные фрагменты, почему выбранные результаты релевантны.
```

Пример (воркфлоуный фрагмент):

```markdown
## Сценарий «низкий трафик БС»

1. **Диапазон дат** — определи max_date по БД, задай baseline и recent.
2. **Отбор БС** — агрегация по NE за recent, топ-N с наименьшим трафиком.
3. **Сравнение baseline vs recent** — классифицировать: «всегда низкий» / «стал низкий» / «аномалия».
4. **RCA** — для «стал низкий» проверить причины по порядку, подкреплять метриками и confidence.
5. **FINAL_REPORT** — по шаблону, сохранить в ai_experiments/<scenario_id>/report.md.
```

### 5.4 Схемы данных / API (для доменных скиллов)

Таблицы с колонками, типами и описанием — чтобы агент строил корректные запросы и интерпретировал результаты.

Пример:

```markdown
## Схема таблицы `network_stats`

| Колонка    | Тип      | Описание          |
|------------|----------|-------------------|
| dt         | DATE     | Дата (YYYY-MM-DD) |
| ne         | TEXT     | Код NE            |
| traffic_ps | REAL     | Трафик PS         |
| drop_rate  | REAL     | Доля дропов, %    |
```

### 5.5 Output format / шаблоны вывода

Как оформлять ответ пользователю или итоговый артефакт (отчёт, презентация).

Пример:

```markdown
## Output format

- Краткий итог (1–2 предложения).
- Совпадения списком: `путь`, `фрагмент`, `тип совпадения` (`fulltext`, `semantic`, `both`), для семантики — `score`.
- Если релевантность низкая — предложить переформулировать запрос.
```

Или шаблон отчёта (как в technical-stats):

```markdown
## Шаблон FINAL_REPORT

Итоговый отчёт сохраняй в `ai_experiments/<scenario_id>/report.md`:

# FINAL_REPORT: Низкий трафик БС

## Executive summary
...

## Топ проблемных БС
| NE | Статус | ...
```

### 5.6 Примеры (Examples)

Конкретные примеры запросов и ответов или вызовов тулов помогают агенту лучше следовать скиллу.

```markdown
## Example Workflow

### Запрос: "eDRX в NB-IoT power saving"
1. Искать техническую документацию.
2. Искать 3GPP, white papers.
3. Сравнить несколько источников.
4. Краткое резюме со ссылками.
```

### 5.7 Совместимость и зависимости (compatibility)

Если не хватает места во frontmatter, можно вынести в отдельную секцию:

```markdown
## Совместимость

- Для семантического поиска: Ollama, модель `qwen3-embedding:4b`, индекс `ai_data/md_semantic_index.jsonl`.
- Если индекс отсутствует — сообщить пользователю: `python tools/md_search.py semantic-index`.
```

### 5.8 Дополнительные материалы (progressive disclosure)

Объёмную справку выносить в отдельные файлы и ссылаться из SKILL.md:

```markdown
## Дополнительно

- Подробные стандарты: [STANDARDS.md](STANDARDS.md)
- Примеры: [examples.md](examples.md)
```

Ссылки — только на один уровень (из SKILL.md в файлы той же папки), без длинных цепочек.

---

## 6. Как указывать инструменты (tools)

### 6.1 Где объявляются тулы

Инструменты определяются в коде агента (в проекте — в `agent.py`) через декоратор `@tool`. Имя инструмента = имя функции в snake_case, например: `search_md_docs`, `query_stats_db`, `execute_analysis_script`.

### 6.2 Как указать в скилле: `allowed-tools`

В frontmatter скилла перечислить через запятую **точные имена** этих функций:

```yaml
---
name: my-skill
description: ...
allowed-tools: query_stats_db, execute_analysis_script, list_experiment_artifacts
---
```

Правила:
- имена в **snake_case**, как в коде;
- через запятую, без лишних пробелов внутри имени;
- только те тулы, которые реально нужны для этого скилла (подсказка агенту, не ограничение на уровне рантайма в текущей реализации).

### 6.3 Описание тулов в теле скилла

В секции Instructions полезно явно назвать тулы и их роль:

```markdown
## Инструменты

| Инструмент | Назначение |
|------------|------------|
| query_stats_db | Только SELECT к ai_data/network_stats.db; при больших выборках — save_to_file=True |
| execute_analysis_script | Запуск сгенерированного analysis.py в ai_experiments/<scenario_id>/ |
| list_experiment_artifacts | Проверка артефактов после запуска скрипта |
```

Или пошагово: «вызови `query_stats_db` с таким SQL…», «затем вызови `execute_analysis_script` с scenario_id и script_content».

### 6.4 Примеры по скиллам проекта

| Скилл | allowed-tools | Назначение тулов |
|-------|----------------|------------------|
| md-search | search_md_docs, search_md_docs_semantic | Полнотекстовый и семантический поиск по .md |
| presentation | execute_python, read_file, write_file | Запуск скрипта создания .pptx, чтение/запись файлов |
| technical-stats | query_stats_db, execute_analysis_script, list_experiment_artifacts | SQL к статистике, запуск аналитического скрипта, просмотр артефактов |
| web-search | tavily_search | Поиск в интернете (если тул подключён) |

---

## 7. Полный пример минимального скилла

Файл: `skills/report-summary/SKILL.md`

```markdown
---
name: report-summary
description: Формирует краткую текстовую сводку по результатам анализа. Использовать, когда пользователь просит «кратко резюмировать», «итог в одном абзаце», «summary по отчёту».
allowed-tools: load_agent_file, save_agent_file
---

# report-summary

## Overview

Навык для составления краткой текстовой сводки по уже имеющимся отчётам или результатам в хранилище агента.

## Instructions

1. Прочитать исходный материал через `load_agent_file(relative_path)` (если путь известен) или сначала получить список через `list_agent_storage`.
2. Выделить главные выводы, цифры и рекомендации (3–7 пунктов).
3. Сохранить сводку через `save_agent_file(relative_path, content)` в файл вида `summaries/<имя_отчёта>_summary.md`.
4. В ответе пользователю дать краткий итог и путь к сохранённому файлу.

## Output format

- Один абзац — суть.
- Нумерованный список ключевых пунктов.
- В конце — «Сводка сохранена: …» с путём к файлу.
```

В `agent.py` добавить в список скиллов: `"report-summary"`.

---

## 8. Чеклист перед добавлением скилла

- [ ] Папка `skills/<имя>/` и файл `SKILL.md` созданы.
- [ ] В frontmatter: `name` (латиница, нижний регистр, дефисы), `description` (что + когда), при необходимости `allowed-tools` и `compatibility`.
- [ ] Имена в `allowed-tools` совпадают с именами функций-тулов в `agent.py` (snake_case).
- [ ] В теле есть хотя бы блок инструкций (Instructions) и при необходимости — схема данных, шаблон вывода, примеры.
- [ ] Имя скилла добавлено в `skill_sources` в `agent.py`.
- [ ] Объём SKILL.md по возможности до 500 строк; детали — в reference.md/examples.md при необходимости.

После этого новый скилл будет подхватываться агентом при следующем запуске.
