# Автономная аналитика БС: выкладки и идеи

## Цель

Сделать так, чтобы агент по запросу вида «найти БС с низким трафиком, объяснить причины, собрать отчёт с графиками и таблицами» сам:
- понимал направление анализа (по промпту и skill);
- строил план и выполнял шаги;
- при необходимости генерировал код (pandas, графики), запускал его и при ошибке отлаживал в ограниченном цикле;
- формировал структурированный итог с артефактами.

## Двухконтурная архитектура

1. **Оркестратор** — планирует анализ, выдвигает гипотезы, вызывает SQL и инструменты, интерпретирует результаты, собирает FINAL_REPORT.
2. **Кодовый контур** — для сложных расчётов и визуализаций: агент генерирует небольшой Python-скрипт, запускает его через `execute_analysis_script`, при падении правит по traceback и повторяет (до 2–3 попыток).

Используются в первую очередь **tools** (query_stats_db, execute_analysis_script, save_agent_file и т.д.); **skills** задают методологию и шаблоны; **subagent** — только при необходимости распараллелить тяжёлые подзадачи.

## Контракт поведения агента

- **PLAN** — в начале: цель, гипотезы, шаги, нужные данные, критерии завершения.
- **STEP_RESULT** — после каждого шага: что сделано, ключевые числа, подтверждена/отклонена гипотеза, confidence (0–1).
- **FINAL_REPORT** — в конце: проблемные БС, причины с подтверждающими KPI, пути к артефактам, рекомендации.
- Без численного подтверждения выводы запрещены; анализ считается завершённым только после FINAL_REPORT и сохранённых артефактов.

## Методология RCA низкого трафика

- **KPI**: трафик (traffic_ps/cs), спрос (calls, rrc_conn), качество (drop_rate, latency_ms, paging_succ), нагрузка (prb_util, cell_load, dl_mbps, ul_mbps), мобильность (handover_cnt).
- **Окна**: baseline (исторический период), recent (последние N дней); сравнение медиан/средних.
- **Классификация БС**: «всегда низкий», «стал низкий», «аномалия/недостаточно данных».
- **Порядок проверки причин**: доступность → качество → спрос → нагрузка → сезонность/внешние факторы.
- **Confidence** для каждой причины: 0.8–1.0 (подтверждено), 0.5–0.8 (вероятно), 0.2–0.5 (гипотеза), ниже — не формулировать как вывод.

## Кодовый контур (генерация и запуск скриптов)

- **GENERATE_SCRIPT** — агент пишет `analysis.py`, который читает из `DB_PATH`, пишет только в `OUTPUT_DIR` (results/, plots/), использует разрешённые библиотеки (pandas, numpy, matplotlib, seaborn, sqlite3, pathlib, os, json).
- **RUN** — `execute_analysis_script(scenario_id, script_content, timeout_sec)`; результат: success, log_path, result_paths, при ошибке — error (traceback).
- **VALIDATE** — `list_experiment_artifacts(scenario_id)` для проверки наличия файлов.
- **DEBUG_LOOP** — при success=False исправить код по error и вызвать `execute_analysis_script` снова; не более 2–3 попыток.

Артефакты сценария: `ai_experiments/<scenario_id>/analysis.py`, `run.log`, `results/*.csv`, `plots/*.png`.

## Guardrails и хранение

- SQL — только read-only (SELECT) через `query_stats_db`.
- В сгенерированных скриптах запрещены subprocess, os.system, eval, exec, __import__.
- Запись: промежуточные данные и логи запросов — `ai_data/`; прогоны сценариев — `ai_experiments/<scenario_id>/`.

## Шаблон FINAL_REPORT

Executive summary → таблица топ проблемных БС → блок RCA по каждой БС (причина, confidence, подтверждающие KPI, рекомендации) → приоритизированный список рекомендаций → пути к артефактам (таблицы, графики, run.log). Сохранять в `ai_experiments/<scenario_id>/report.md` и/или в хранилище агента.

## Ключевые файлы

| Назначение | Путь |
|------------|------|
| Агент, промпт, инструменты | `agent.py` |
| Запуск аналитического скрипта | `tools/analysis_runner.py` |
| Методология и сценарий «низкий трафик» | `skills/technical-stats/SKILL.md` |
| Ограничения и структура артефактов | `ai_doc/analytics_guardrails.md` |
| Шаблон отчёта | `ai_doc/final_report_template.md` |
| Команды запуска | `quickstart.md` (п. 10) |

## Запуск

```bash
python agent.py --query "Найди 5 БС с самым низким трафиком за последние 14 дней, проведи анализ причин и сформируй отчёт с таблицей и выводами."
```

Артефакты появятся в `ai_experiments/<scenario_id>/` и в хранилище агента (например `ai_data/agent_storage/`).
